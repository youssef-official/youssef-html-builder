<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Website Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0b1020;
  --panel:#020617;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#f472b6;
  --error:#f87171;
}

*{box-sizing:border-box}

body{
  margin:0;
  height:100vh;
  font-family:Inter,system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
}

header{
  padding:14px 20px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header button{
  background:none;
  border:1px solid var(--border);
  color:var(--muted);
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
  font-size:12px;
}

.main{flex:1;position:relative}

.view{
  position:absolute;
  inset:0;
  display:none;
}
.view.active{display:block}

.center{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100%;
  color:var(--muted);
}

iframe{
  width:100%;
  height:100%;
  border:none;
  background:white;
}

pre{
  margin:0;
  padding:20px;
  height:100%;
  background:var(--panel);
  overflow:auto;
  white-space:pre-wrap;
  font-size:13px;
}

.chat{
  display:flex;
  flex-direction:column;
  height:100%;
}

.chat-messages{
  flex:1;
  padding:16px;
  overflow:auto;
}

.msg{margin-bottom:10px;font-size:14px}
.msg.user{color:#93c5fd}
.msg.ai{color:#a7f3d0}
.msg.error{color:var(--error)}

.chat-input{
  border-top:1px solid var(--border);
  padding:12px;
  display:flex;
  gap:8px;
}

.chat-input input{
  flex:1;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px;
  color:var(--text);
}

.chat-input button{
  background:var(--accent);
  border:none;
  color:#020617;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
}

.footer{
  height:64px;
  background:var(--panel);
  border-top:1px solid var(--border);
  display:flex;
  justify-content:space-around;
  align-items:center;
}

.footer button{
  background:none;
  border:none;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  gap:4px;
  font-size:11px;
  cursor:pointer;
}
.footer button.active{color:var(--accent)}
.footer svg{width:22px;height:22px;fill:currentColor}

/* API KEY MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal-box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:24px;
  width:90%;
  max-width:420px;
}
.modal-box h2{margin-top:0}
.modal-box input{
  width:100%;
  margin-top:12px;
  background:#020617;
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px;
  color:var(--text);
}
.modal-box button{
  margin-top:16px;
  width:100%;
  background:var(--accent);
  border:none;
  padding:12px;
  border-radius:10px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  AI Website Studio
  <button onclick="resetKey()">Change API Key</button>
</header>

<!-- API KEY MODAL -->
<div class="modal" id="keyModal" style="display:none">
  <div class="modal-box">
    <h2>Enter OpenRouter API Key</h2>
    <p class="muted">Your key is stored locally only.</p>
    <input id="apiKeyInput" placeholder="sk-or-v1-..." />
    <button onclick="saveKey()">Save</button>
  </div>
</div>

<div class="main">

  <div class="view active" id="previewView">
    <div class="center" id="previewPlaceholder">Preview will appear here</div>
    <iframe id="previewFrame" style="display:none"></iframe>
  </div>

  <div class="view" id="codeView">
    <div class="center" id="codePlaceholder">Code will be generated here</div>
    <pre id="codeOutput" style="display:none"></pre>
  </div>

  <div class="view" id="chatView">
    <div class="chat">
      <div class="chat-messages" id="chat"></div>
      <div class="chat-input">
        <input id="chatInput" placeholder="عاوز موقع ايه؟ أو عدّل على الموجود..." />
        <button onclick="sendChat()">Send</button>
      </div>
    </div>
  </div>

</div>

<div class="footer">
  <button class="active" onclick="switchView('preview')">
    <svg viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7z"/></svg>
    Preview
  </button>
  <button onclick="switchView('code')">
    <svg viewBox="0 0 24 24"><path d="M8 17l-5-5 5-5M16 7l5 5-5 5"/></svg>
    Code
  </button>
  <button onclick="switchView('chat')">
    <svg viewBox="0 0 24 24"><path d="M4 4h16v12H6l-2 2z"/></svg>
    Chat
  </button>
</div>

<script>
const MODEL="mistralai/devstral-2512:free";
let htmlCode=localStorage.getItem("html")||"";
let chatHistory=JSON.parse(localStorage.getItem("chat")||"[]");

function getKey(){return localStorage.getItem("OPENROUTER_KEY")}
function saveKey(){
  const k=document.getElementById("apiKeyInput").value.trim();
  if(!k)return;
  localStorage.setItem("OPENROUTER_KEY",k);
  document.getElementById("keyModal").style.display="none";
}
function resetKey(){
  localStorage.removeItem("OPENROUTER_KEY");
  location.reload();
}

function switchView(v){
  document.querySelectorAll(".view").forEach(x=>x.classList.remove("active"));
  document.getElementById(v+"View").classList.add("active");
  document.querySelectorAll(".footer button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".footer button")[["preview","code","chat"].indexOf(v)].classList.add("active");
}

async function sendChat(){
  const key=getKey();
  if(!key)return;

  const input=document.getElementById("chatInput");
  const msg=input.value.trim();
  if(!msg)return;
  input.value="";

  chatHistory.push({role:"user",content:msg});
  renderChat();

  try{
    const system=htmlCode
      ? "Modify ONLY the existing HTML. Return ONLY HTML."
      : "Generate a FULL professional website. Return ONLY HTML.";

    const prompt=htmlCode ? htmlCode+"\n\nUser request:\n"+msg : msg;

    const res=await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+key,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        model:MODEL,
        messages:[
          {role:"system",content:system},
          {role:"user",content:prompt}
        ],
        max_tokens:8000
      })
    });

    if(!res.ok) throw new Error("API error "+res.status);

    htmlCode=(await res.json()).choices[0].message.content;
    localStorage.setItem("html",htmlCode);
    showResult();
    chatHistory.push({role:"ai",content:"تم التنفيذ ✅ روح Preview أو Code"});
  }catch(e){
    chatHistory.push({role:"error",content:e.message});
  }

  renderChat();
}

function showResult(){
  previewPlaceholder.style.display="none";
  previewFrame.style.display="block";
  previewFrame.srcdoc=htmlCode;
  codePlaceholder.style.display="none";
  codeOutput.style.display="block";
  codeOutput.textContent=htmlCode;
}

function renderChat(){
  const c=document.getElementById("chat");
  c.innerHTML="";
  chatHistory.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+m.role;
    d.textContent=m.content;
    c.appendChild(d);
  });
  localStorage.setItem("chat",JSON.stringify(chatHistory));
}

if(!getKey()) document.getElementById("keyModal").style.display="flex";
if(htmlCode) showResult();
renderChat();
</script>

</body>
</html>